<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>xmap • xmap</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="xmap">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">xmap</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/xmap.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/handling-xmap-tbls.html">Handling Crossmap Tibbles</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cynthiahqy/xmap/"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>xmap</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cynthiahqy/xmap/vignettes/xmap.Rmd" class="external-link"><code>vignettes/xmap.Rmd</code></a></small>
      <div class="d-none name"><code>xmap.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cynthiahqy/xmap" class="external-link">xmap</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="the-crossmaps-framework-and-xmap-workflow">The Crossmaps Framework and <code>{xmap}</code> workflow<a class="anchor" aria-label="anchor" href="#the-crossmaps-framework-and-xmap-workflow"></a>
</h2>
<p>This package is an implementation of the Crossmaps Framework for
unified <em>specification, verification, implementation and
documentation</em> of operations involved in transforming aggregate
statistics between related measurement instruments (e.g. classification
codes).</p>
<p>The framework conceptualises the aggregation of redistribution of
numeric masses between related taxonomic structures as an operation
which applies a graph-based representation of mapping and redistribution
logic between source and target keys (the <em>crossmap</em>), to
conformable key-value pairs (<em>shared mass array</em>).</p>
<p>A <em>crossmap</em> specifies:</p>
<ul>
<li>related pairs of source and target key (e.g. states in country)</li>
<li>weights between 0 and 1 for distributing numeric mass between each
related pair of source and target keys (e.g. 25% of country-level GDP
-&gt; state-A)</li>
</ul>
<p>A <em>shared mass array</em> is a collection of key-value pairs,
where the values form a shared numeric and the keys are parts of a
shared conceptual whole (e.g. GDP by state -&gt; country)</p>
<p>The crossmaps framework is an alternative approach to data
transformation that removes the need for bespoke code to handle data
preparation involving many-to-one or one-to-many operations.</p>
<!-- TODO: ADD crossmaps before/after image. -->
<p>The framework gives rise to assertions on input <em>crossmap</em> and
<em>shared mass arrays</em> which ensure the transformations are valid,
and implemented exactly as specified. Valid and well-documented
transformation workflows should have the following properties:</p>
<ul>
<li>preservation of the shared total mass before and after
transformation. For example, country level GDP should remain constant
regardless of disaggregation method or granularity (e.g. state vs
county)</li>
<li>explicit handling of missing values, without any implicit missing
value arithemtic (e.g. aggregating ‘missing’ state-level mass to
country-level by treating the values as zeros via expressions like
<code>sum(state, na.rm = TRUE)</code>)</li>
</ul>
<p>See the related paper, <a href="https://arxiv.org/abs/2406.14163" class="external-link"><em>A Unified Statistical And
Computational Framework For Ex-Post Harmonisation Of Aggregate
Statistics</em></a>, for further details on the conditions which
guarantee the above properties. This package implements workflow
warnings and errors to ensure relevant conditions are met.</p>
</div>
<div class="section level2">
<h2 id="example-country-state-mappings">Example: Country-State Mappings<a class="anchor" aria-label="anchor" href="#example-country-state-mappings"></a>
</h2>
<p>Consider data transformations which reference relations between
hierarchical administrative regions.</p>
<p>In the following example, we use some basic data manipulation
operations from <a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a> to generate mapping weights for
transforming numeric mass (e.g. GDP):</p>
<ul>
<li>aggregating from state-level to country-level,</li>
<li>redistributing from country-level to state-level</li>
</ul>
<div class="section level3">
<h3 id="aggregation-coverage-and-missing-value-checks">Aggregation, Coverage, and Missing Value Checks<a class="anchor" aria-label="anchor" href="#aggregation-coverage-and-missing-value-checks"></a>
</h3>
<p>For aggregation, we use unit weights:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aus_state_agg_links</span> <span class="op">&lt;-</span> <span class="va">demo</span><span class="op">$</span><span class="va">aus_state_pairs</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ones <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span></code></pre></div>
<p>Links are validated when coercing them into crossmaps, and some
additional information about the transformation is computed (i.e. how
many unique keys are in the source and target taxonomies):</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">agg_xmap</span> <span class="op">&lt;-</span> <span class="va">aus_state_agg_links</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_xmap_tbl.html">as_xmap_tbl</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">state</span>, to <span class="op">=</span> <span class="va">ctry</span>, weight_by <span class="op">=</span> <span class="va">ones</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A crossmap tibble: 8 × 3</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># with unique keys:  [8] state -&gt; [1] ctry</span></span></span>
<span><span class="co">#&gt;   .from$state .to$ctry .weight_by$ones</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> AU-ACT      AUS                    1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> AU-NSW      AUS                    1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> AU-NT       AUS                    1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> AU-QLD      AUS                    1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> AU-SA       AUS                    1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> AU-TAS      AUS                    1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> AU-VIC      AUS                    1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> AU-WA       AUS                    1</span></span></code></pre></div>
<p>The unit weights represent a “transfer” of 100% of the source values
indexed by <code>.from</code> keys to the target <code>.to</code>
keys.</p>
<p>Let’s generate some dummy state-level data to apply our aggregation
to:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1395</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">aus_state_data</span> <span class="op">&lt;-</span> <span class="va">demo</span><span class="op">$</span><span class="va">aus_state_pairs</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    gdp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, <span class="fl">100</span>, <span class="fl">2000</span><span class="op">)</span>,</span>
<span>    ref <span class="op">=</span> <span class="fl">100</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 8 × 4</span></span></span>
<span><span class="co">#&gt;   ctry  state    gdp   ref</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> AUS   AU-ACT <span style="text-decoration: underline;">1</span>626.   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> AUS   AU-NSW <span style="text-decoration: underline;">1</span>244.   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> AUS   AU-NT   703.   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> AUS   AU-QLD  239.   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> AUS   AU-SA  <span style="text-decoration: underline;">1</span>388.   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> AUS   AU-TAS <span style="text-decoration: underline;">1</span>192.   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> AUS   AU-VIC <span style="text-decoration: underline;">1</span>535.   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> AUS   AU-WA   306.   100</span></span></code></pre></div>
<p>Now to transform / aggregate our data:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">aus_ctry_data</span> <span class="op">&lt;-</span> <span class="va">aus_state_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/apply_xmap.html">apply_xmap</a></span><span class="op">(</span></span>
<span>    .xmap <span class="op">=</span> <span class="va">agg_xmap</span>,</span>
<span>    values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">gdp</span>, <span class="va">ref</span><span class="op">)</span>,</span>
<span>    keys_from <span class="op">=</span> <span class="va">state</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 3</span></span></span>
<span><span class="co">#&gt;   ctry    gdp   ref</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> AUS   <span style="text-decoration: underline;">8</span>233.   800</span></span></code></pre></div>
<p>What happens if our crossmap was missing instructions for multiple
states?</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## dropping links</span></span>
<span><span class="va">agg_xmap</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="op">]</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A crossmap tibble: 3 × 3</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># with unique keys:  [3] state -&gt; [1] ctry</span></span></span>
<span><span class="co">#&gt;   .from$state .to$ctry .weight_by$ones</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> AU-ACT      AUS                    1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> AU-NSW      AUS                    1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> AU-NT       AUS                    1</span></span>
<span></span>
<span><span class="co">## will lead to an error!</span></span>
<span><span class="fu"><a href="../reference/apply_xmap.html">apply_xmap</a></span><span class="op">(</span></span>
<span>  .data <span class="op">=</span> <span class="va">aus_state_data</span>,</span>
<span>  .xmap <span class="op">=</span> <span class="va">agg_xmap</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="op">]</span>,</span>
<span>  values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">gdp</span>, <span class="va">ref</span><span class="op">)</span>,</span>
<span>  keys_from <span class="op">=</span> <span class="va">state</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `apply_xmap()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> One or more keys in `.data` do not have corresponding links in `.xmap`</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Add missing links to `.xmap` or subset `.data`</span></span></code></pre></div>
<p>This error prevents the accidental dropping of observations by
incomplete specification of transformation instruction.</p>
<p>To inspect and remedy this issue, we can use
<code><a href="../reference/apply_xmap.html">diagnose_apply_xmap()</a></code> to find out which keys in
<code>.data</code> are not covered by the <code>.xmap</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/apply_xmap.html">diagnose_apply_xmap</a></span><span class="op">(</span></span>
<span>  .data <span class="op">=</span> <span class="va">aus_state_data</span>,</span>
<span>  .xmap <span class="op">=</span> <span class="va">agg_xmap</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="op">]</span>,</span>
<span>  values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">gdp</span>, <span class="va">ref</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: <span style="color: #BB0000;">✖</span> Found 8 keys in `.data` without corresponding match in `.xmap$.from`</span></span>
<span><span class="co">#&gt; See .$not_covered</span></span>
<span><span class="co">#&gt; $not_covered</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 8 × 2</span></span></span>
<span><span class="co">#&gt;   .key         .value$gdp  $ref</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;tibble[,0]&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>                   <span style="text-decoration: underline;">1</span>626.   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>                   <span style="text-decoration: underline;">1</span>244.   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>                    703.   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>                    239.   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>                   <span style="text-decoration: underline;">1</span>388.   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>                   <span style="text-decoration: underline;">1</span>192.   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span>                   <span style="text-decoration: underline;">1</span>535.   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span>                    306.   100</span></span></code></pre></div>
<p>Missing values will also be flagged to encourage explicit handling of
missing values before the <code><a href="../reference/apply_xmap.html">apply_xmap()</a></code> mapping
transformation:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># add some `NA`</span></span>
<span><span class="va">aus_state_data_na</span> <span class="op">&lt;-</span> <span class="va">aus_state_data</span></span>
<span><span class="va">aus_state_data_na</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span>, <span class="st">"gdp"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="fu"><a href="../reference/apply_xmap.html">apply_xmap</a></span><span class="op">(</span></span>
<span>  .data <span class="op">=</span> <span class="va">aus_state_data_na</span>,</span>
<span>  .xmap <span class="op">=</span> <span class="va">agg_xmap</span>,</span>
<span>  values_from <span class="op">=</span> <span class="va">gdp</span>,</span>
<span>  keys_from <span class="op">=</span> <span class="va">state</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `apply_xmap()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Missing values not allowed in `.data` columns: gdp</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Remove or replace missing values.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="redistribution-valid-weights-and-preserving-totals">Redistribution, valid weights and preserving totals<a class="anchor" aria-label="anchor" href="#redistribution-valid-weights-and-preserving-totals"></a>
</h3>
<p>For redistributing, we can choose any weights as long as the sum of
weights on outgoing links from each source key totals one (or
<code><a href="https://dplyr.tidyverse.org/reference/near.html" class="external-link">dplyr::near()</a></code> enough). This ensures that we only split
source values into percentage parts that sum to 100%.</p>
<p>A common naive strategy is to distribute equally amongst related
target keys:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">demo</span><span class="op">$</span><span class="va">aus_state_pairs</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">ctry</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>equal <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html" class="external-link">n_distinct</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_xmap_tbl.html">as_xmap_tbl</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">ctry</span>, to <span class="op">=</span> <span class="va">state</span>, weight_by <span class="op">=</span> <span class="va">equal</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A crossmap tibble: 8 × 3</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># with unique keys:  [1] ctry -&gt; [8] state</span></span></span>
<span><span class="co">#&gt;   .from$ctry .to$state .weight_by$equal</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> AUS        AU-ACT               0.125</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> AUS        AU-NSW               0.125</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> AUS        AU-NT                0.125</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> AUS        AU-QLD               0.125</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> AUS        AU-SA                0.125</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> AUS        AU-TAS               0.125</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> AUS        AU-VIC               0.125</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> AUS        AU-WA                0.125</span></span></code></pre></div>
<p>If we use invalid weights, such as unit weights,
<code><a href="../reference/as_xmap_tbl.html">as_xmap_tbl()</a></code> will error:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">demo</span><span class="op">$</span><span class="va">aus_state_pairs</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ones <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_xmap_tbl.html">as_xmap_tbl</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">ctry</span>, to <span class="op">=</span> <span class="va">state</span>, weight_by <span class="op">=</span> <span class="va">ones</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `xmap_tbl()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Invalid `.weight_by` found for some links</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> The total outgoing `.weight_by` for some `.from` nodes are not near enough to</span></span>
<span><span class="co">#&gt;   1</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Modify `.weight_by` or adjust `tol` and try again.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Use `diagnose_xmap_tbl() for more information.</span></span></code></pre></div>
<p>Except in the case of one-to-one mappings, crossmaps are generally
lateral (one-way), and have different weights in each direction.</p>
<p>A more sophisticated strategy for generating weights is to use
reference information. For example, we can use population shares to
redistribute GDP between states:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">split_xmap_pop</span> <span class="op">&lt;-</span> <span class="va">demo</span><span class="op">$</span><span class="va">aus_state_pop_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">ctry</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>pop_share <span class="op">=</span> <span class="va">pop</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_xmap_tbl.html">as_xmap_tbl</a></span><span class="op">(</span></span>
<span>    from <span class="op">=</span> <span class="va">ctry</span>, to <span class="op">=</span> <span class="va">state</span>, weight_by <span class="op">=</span> <span class="va">pop_share</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A crossmap tibble: 8 × 3</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># with unique keys:  [1] ctry -&gt; [8] state</span></span></span>
<span><span class="co">#&gt;   .from$ctry .to$state .weight_by$pop_share</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> AUS        AU-ACT                 0.017<span style="text-decoration: underline;">6</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> AUS        AU-NSW                 0.314  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> AUS        AU-NT                  0.009<span style="text-decoration: underline;">65</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> AUS        AU-QLD                 0.205  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> AUS        AU-SA                  0.070<span style="text-decoration: underline;">1</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> AUS        AU-TAS                 0.022<span style="text-decoration: underline;">0</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> AUS        AU-VIC                 0.255  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> AUS        AU-WA                  0.107</span></span></code></pre></div>
<p>Let’s redistribute the country level data we aggregated above back to
state level using our calcuted population weights:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aus_state_data2</span> <span class="op">&lt;-</span> <span class="va">aus_ctry_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ref <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/apply_xmap.html">apply_xmap</a></span><span class="op">(</span><span class="va">split_xmap_pop</span>,</span>
<span>    values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">gdp</span>, <span class="va">ref</span><span class="op">)</span>,</span>
<span>    keys_from <span class="op">=</span> <span class="va">ctry</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Note: that the values in the transformed <code>ref</code> column do
not exactly match the float values in <code>.weight_by$pop_share</code>
used as transformation weights. This is due to floating point
inaccuracies. Over larger transformations with more keys, this may
result in slight mismatches between the total numeric mass before and
after transformation.</p>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 8 × 5</span></span></span>
<span><span class="co">#&gt;   .from$ctry state     gdp    ref .weight_by$pop_share</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> AUS        AU-ACT  145.   176.               0.017<span style="text-decoration: underline;">6</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> AUS        AU-NSW <span style="text-decoration: underline;">2</span>584.  <span style="text-decoration: underline;">3</span>139.               0.314  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> AUS        AU-NT    79.4   96.5              0.009<span style="text-decoration: underline;">65</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> AUS        AU-QLD <span style="text-decoration: underline;">1</span>687.  <span style="text-decoration: underline;">2</span>049.               0.205  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> AUS        AU-SA   577.   701.               0.070<span style="text-decoration: underline;">1</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> AUS        AU-TAS  181.   220.               0.022<span style="text-decoration: underline;">0</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> AUS        AU-VIC <span style="text-decoration: underline;">2</span>096.  <span style="text-decoration: underline;">2</span>546.               0.255  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> AUS        AU-WA   883.  <span style="text-decoration: underline;">1</span>072.               0.107</span></span></code></pre>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://www.cynthiahqy.com" class="external-link">Cynthia Huang</a>, <a href="https://sites.google.com/site/laurapuzzello" class="external-link">Laura Puzzello</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
